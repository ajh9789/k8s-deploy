<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>TinySD 이미지 생성</title>
</head>
<body>
  <h1>TinySD 이미지 생성</h1>

  <form id="generate-form">
    <input type="text" id="prompt" placeholder="텍스트 프롬프트 입력" required />
    <button type="submit">이미지 생성</button>
  </form>

  <p id="status"></p>

  <!-- 이미지 출력 -->
  <img id="result-image" style="max-width: 500px; display: none;" />

  <!-- PSD 다운로드 링크 -->
  <a id="psd-download" href="#" download style="display: none;">.PSD 파일 다운로드</a>

  <!-- PSD 자동 실행 버튼 -->
  <button id="open-psd" style="display: none;">PSD 자동 실행</button>

  <script>
    const API_BASE = "https://n8n.koreacentral.cloudapp.azure.com";

    const form = document.getElementById('generate-form');
    const status = document.getElementById('status');
    const resultImage = document.getElementById('result-image');
    const psdLink = document.getElementById('psd-download');
    const openPsdBtn = document.getElementById('open-psd');

    form.onsubmit = async (e) => {
      e.preventDefault();
      const prompt = document.getElementById('prompt').value;
      status.textContent = "이미지 생성 요청 중...";
      resultImage.style.display = "none";
      psdLink.style.display = "none";
      openPsdBtn.style.display = "none";

      try {
        const res = await fetch(`${API_BASE}/api/generate-image`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });
        const data = await res.json();
        const taskId = data.task_id;

        const checkStatus = async () => {
          const resp = await fetch(`${API_BASE}/api/result/${taskId}`);
          const result = await resp.json();

          if (result.status === "PENDING") {
            status.textContent = "이미지 생성 중...";
            setTimeout(checkStatus, 2000);
          } else if (result.status === "SUCCESS") {
            status.textContent = "완료!";
            // PNG 미리보기
            resultImage.src = result.png_url;
            resultImage.style.display = "block";

            // PSD 다운로드 링크 설정
            psdLink.href = result.psd_url;
            psdLink.download = `${taskId}.psd`;
            psdLink.style.display = "inline-block";

            // PSD 자동 실행 버튼 설정
            openPsdBtn.style.display = "inline-block";
            openPsdBtn.onclick = async () => {
              try {
                await fetch("http://localhost:5001/download-and-open-psd", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    url: result.psd_url,
                    filename: `${taskId}.psd`
                  })
                });
                alert("PSD 파일 실행 요청을 보냈습니다.");
              } catch (err) {
                alert("PSD 실행 요청 실패: " + err.message);
              }
            };
          } else {
            status.textContent = "에러 발생!";
          }
        };

        checkStatus();
      } catch (err) {
        status.textContent = "요청 실패: " + err.message;
      }
    };
  </script>
</body>
</html>
