<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>TinySD 이미지 생성</title>
</head>
<body>
  <h1>TinySD 이미지 생성</h1>

  <form id="generate-form">
    <input type="text" id="prompt" placeholder="텍스트 프롬프트 입력" required />
    <button type="submit">이미지 생성</button>
  </form>

  <p id="status"></p>

  <!-- 이미지 출력 -->
  <img id="result-image" style="max-width: 500px; display: none;" />

  <!-- PSD 다운로드 링크 -->
  <a id="psd-download" href="#" download style="display: none;">.PSD 파일 다운로드</a>

  <script>
    const API_BASE = "http://20.249.163.221";

    const form = document.getElementById('generate-form');
    const status = document.getElementById('status');
    const resultImage = document.getElementById('result-image');
    const psdLink = document.getElementById('psd-download');

    form.onsubmit = async (e) => {
      e.preventDefault();
      const prompt = document.getElementById('prompt').value;
      status.textContent = "이미지 생성 요청 중...";
      resultImage.style.display = "none";
      psdLink.style.display = "none";

      try {
        const res = await fetch(`${API_BASE}/api/generate-image`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });
        const data = await res.json();
        const taskId = data.task_id;

        const checkStatus = async () => {
          const resp = await fetch(`${API_BASE}/api/result/${taskId}`);
          const result = await resp.json();
          if (result.status === "PENDING") {
            status.textContent = "이미지 생성 중...";
            setTimeout(checkStatus, 2000);
          } else if (result.status === "SUCCESS") {
            status.textContent = "완료!";
            // PNG 미리보기
            resultImage.src = result.png_url;
            resultImage.style.display = "block";
            // PSD 다운로드 링크 표시
            psdLink.href = result.psd_url;
            psdLink.style.display = "inline-block";
          } else {
            status.textContent = "에러 발생!";
          }
        };
        checkStatus();
      } catch (err) {
        status.textContent = "요청 실패: " + err.message;
      }
    };
  </script>
</body>
</html>