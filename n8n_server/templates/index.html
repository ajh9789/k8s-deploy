<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>n8n Chat Demo</title>
    <style>
        :root {
            --gap: 1rem;
            --radius: .75rem;
            --primary: #2563eb;
            --bg: #f8fafc;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: system-ui, sans-serif;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--gap);
            height: 100vh;
        }
        h1 { margin: .25rem 0 1rem; font-size: 1.4rem; }
        #chatbox {
            flex: 1 1 auto;
            width: 100%;
            max-width: 600px;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: var(--radius);
            padding: var(--gap);
            overflow-y: auto;
        }
        .msg { margin-bottom: .6rem; line-height: 1.45; }
        .msg strong { color: var(--primary); }
        form {
            display: flex;
            gap: .5rem;
            width: 100%;
            max-width: 600px;
            margin-top: var(--gap);
        }
        input[type="text"] {
            flex: 1;
            padding: .65rem .9rem;
            font-size: 1rem;
            border: 1px solid #d1d5db;
            border-radius: var(--radius);
        }
        button {
            padding: .65rem 1rem;
            font-size: 1rem;
            border: none;
            border-radius: var(--radius);
            background: var(--primary);
            color: #fff;
            cursor: pointer;
            flex-shrink: 0;
        }
        button:disabled { opacity: .4; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>n8n Ï±óÎ¥á</h1>

    <div id="chatbox" aria-live="polite" aria-label="ÎåÄÌôî ÎÇ¥Ïö©"></div>

    <form id="chat-form" autocomplete="off">
        <button type="button" id="addFileBtn">+</button>
        <input id="userInput" type="text" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî‚Ä¶" />
        <button type="button" id="sttBtn">üé§</button> 
        <button type="submit">Ï†ÑÏÜ°</button>
        
        <input type="file" id="fileInput" accept="image/*" style="display: none;" />
    </form>
    
    <script src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle.js"></script>

    <script>
        /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
         * Utility helpers
         * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        const qs = (sel, scope = document) => scope.querySelector(sel);
        const on = (el, type, cb) => el.addEventListener(type, cb);
        const escapeHTML = str => str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));

        /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        const chatbox   = qs('#chatbox');
        const userInput = qs('#userInput');
        const form      = qs('#chat-form');
        const sendBtn   = qs('button[type="submit"]', form);
        const sttBtn    = qs('#sttBtn');
        
        // --- [ÏàòÏ†ïÎêú Î∂ÄÎ∂Ñ] ---
        const addFileBtn = qs('#addFileBtn'); // Ïò§ÌÉÄ ÏàòÏ†ï (addfileBtn -> addFileBtn)
        const fileInput  = qs('#fileInput');  // Ïù¥Ï†ú Ïù¥ ÏöîÏÜåÍ∞Ä Ï°¥Ïû¨ÌïòÎØÄÎ°ú Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Ï∞æÏïÑÏòµÎãàÎã§.
        
        // --- ÌååÏùº Ï≤®Î∂Ä Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ---
        on(addFileBtn, 'click', () => {
            fileInput.click(); // Ïà®Í≤®ÏßÑ file inputÏùÑ ÌÅ¥Î¶≠ÏãúÌÇ¥
        });

        // --- ÌååÏùºÏù¥ Ïã§Ï†úÎ°ú ÏÑ†ÌÉùÎêòÏóàÏùÑ ÎïåÏùò Ïù¥Î≤§Ìä∏ ---
        on(fileInput, 'change', (e) => {
            const file = e.target.files[0];
            if (file) {
                uploadImageAndShow(file);
            }
            fileInput.value = '';
        });

        // --- ÌÖçÏä§Ìä∏ ÏûÖÎ†•Ï∞ΩÏóê Î∂ôÏó¨ÎÑ£Í∏∞ Ïù¥Î≤§Ìä∏ ---
        on(userInput, 'paste', (e) => {
            const items = e.clipboardData.items;
            for (const item of items) {
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    uploadImageAndShow(file);
                    e.preventDefault();
                    return;
                }
            }
        });

        // --- Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Î∞è Ï≤òÎ¶¨Î•º ÏúÑÌïú Ìï®Ïàò ---
        const uploadImageAndShow = async (file) => {
            const formData = new FormData();
            formData.append('image_file', file);
            addLine('ÎÇò', 'Ïù¥ÎØ∏ÏßÄ Ï†ÑÏÜ° Ï§ë...');

            try {
                const res = await fetch('/upload-image', {
                    method: 'POST',
                    body: formData,
                });

                if (!res.ok) throw new Error(`Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ïã§Ìå®: ${res.statusText}`);

                const result = await res.json();
                const imageUrl = result.image_url;

                const p = document.createElement('p');
                p.className = 'msg';
                p.innerHTML = `<strong>ÎÇò:</strong> <img src="${escapeHTML(imageUrl)}" alt="ÏóÖÎ°úÎìúÎêú Ïù¥ÎØ∏ÏßÄ" width="200">`;
                chatbox.appendChild(p);
                chatbox.scrollTop = chatbox.scrollHeight;

            } catch (err) {
                console.error(err);
                addLine('ÏãúÏä§ÌÖú', `‚ö†Ô∏è ${err.message}`);
            }
        };

        // --- ÎÇòÎ®∏ÏßÄ ÏΩîÎìúÎäî ÎèôÏùº ---
        let sessionId = sessionStorage.getItem('chatSessionId');
        if (!sessionId) {
            sessionId = `web-user-${Date.now()}`;
            sessionStorage.setItem('chatSessionId', sessionId);
        }

        const addLine = (who, text) => {
            const p = document.createElement('p');
            p.className = 'msg';
            p.innerHTML = `<strong>${who}:</strong> ${escapeHTML(text)}`;
            chatbox.appendChild(p);
            chatbox.scrollTop = chatbox.scrollHeight;
        };

        const sendMessage = async ev => {
            ev?.preventDefault();
            const msg = userInput.value.trim();
            if (!msg) return;

            addLine('ÎÇò', msg);
            userInput.value = '';
            userInput.focus();
            sendBtn.disabled = true;

            try {
                const res = await fetch('/send-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: msg, sessionId })
                });

                if (!res.ok) throw new Error(`ÏÑúÎ≤Ñ Ïò§Î•ò ${res.status}`);
                const { text } = await res.json();
                addLine('Ï±óÎ¥á', text ?? '[Îπà ÏùëÎãµ]');
            } catch (err) {
                console.error(err);
                addLine('ÏãúÏä§ÌÖú', `‚ö†Ô∏è ${err.message}`);
            } finally {
                sendBtn.disabled = false;
            }
        };

        // --- STT Í∏∞Îä• Ï¥àÍ∏∞Ìôî Î∞è Ïù¥Î≤§Ìä∏ Ìï∏Îì§ÎßÅ ---
        let recognizer;
        on(document, 'DOMContentLoaded', async () => {
            sttBtn.disabled = true;
            try {
                const response = await fetch('/api/get-speech-token');
                if (!response.ok) throw new Error('Ïù∏Ï¶ù ÌÜ†ÌÅ∞ÏùÑ Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                
                const data = await response.json();
                const speechConfig = SpeechSDK.SpeechConfig.fromAuthorizationToken(data.token, data.region);
                speechConfig.speechRecognitionLanguage = 'ko-KR';
                
                const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
                recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);
                
                sttBtn.disabled = false;
                console.log("ÏùåÏÑ± Ïù∏ÏãùÍ∏∞ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å");

            } catch (error) {
                console.error("ÏùåÏÑ± Ïù∏ÏãùÍ∏∞ Ï¥àÍ∏∞Ìôî Ïã§Ìå®:", error);
                sttBtn.innerHTML = '‚ö†Ô∏è';
            }
        });

        on(sttBtn, 'click', () => {
            if (!recognizer) return;
            
            sttBtn.disabled = true;
            sttBtn.innerHTML = 'üëÇ';
            userInput.value = '';
            userInput.placeholder = 'ÎßêÏîÄÌïòÏÑ∏Ïöî...';

            recognizer.recognizeOnceAsync(result => {
                if (result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                    userInput.value = result.text;
                } else {
                    userInput.placeholder = 'ÏùåÏÑ± Ïù∏Ïãù Ïã§Ìå®. Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.';
                }
                sttBtn.disabled = false;
                sttBtn.innerHTML = 'üé§';
            });
        });

        // --- Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ---
        on(form, 'submit', sendMessage);
        on(userInput, 'keydown', e => { if (e.key === 'Enter' && !e.shiftKey) sendMessage(e); });
    </script>
</body>
</html>