apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: slack-config
  namespace: monitoring
  labels:
    # Operator가 이 설정을 선택하도록 하는 라벨입니다.
    alertmanagerConfig: main
spec:
  route:
    # 모든 알림의 기본 수신자
    receiver: "slack"

    # 5분마다 알림을 반복하도록 설정 (route 내부에 위치해야 함)
    repeatInterval: 5m

    # 하위 규칙은 비워둠
    routes: []

  receivers:
  - name: "slack"
    slackConfigs:
    - apiURL:
        key: slackUrl
        name: alertmanager-slack-secret
      channel: '#monitoring-alerts'
      sendResolved: true
      title: '[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ if .CommonLabels.alertname }}{{ .CommonLabels.alertname }}{{ else }}알림 발생{{ end }}'
      text: >-
        {{ range .Alerts -}}
        *요약 (Summary):* {{ .Annotations.summary }}
        *상세 (Description):* {{ .Annotations.description }}
        *발생 위치 (Instance):* `{{ .Labels.instance }}`
        *로그 확인:* <{{ .GeneratorURL }}|Prometheus Graph>
        ------------------------------------
        {{ end }}